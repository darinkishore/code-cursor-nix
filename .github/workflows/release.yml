name: Create Release

on:
  push:
    branches:
      - main
    paths:
      - 'package.nix'

permissions:
  contents: write

jobs:
  create-release:
    name: Create GitHub release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if version changed
        id: version_check
        run: |
          CURRENT_VERSION=$(grep -oP 'version = "\K[^"]+' package.nix | head -1)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          git show HEAD~1:package.nix > /tmp/old_package.nix 2>/dev/null || true

          if [ -f /tmp/old_package.nix ]; then
            PREVIOUS_VERSION=$(grep -oP 'version = "\K[^"]+' /tmp/old_package.nix | head -1)
            echo "previous_version=$PREVIOUS_VERSION" >> $GITHUB_OUTPUT

            if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
              echo "version_changed=true" >> $GITHUB_OUTPUT
              echo "Version changed: $PREVIOUS_VERSION -> $CURRENT_VERSION"
            else
              echo "version_changed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "version_changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Check if release exists
        if: steps.version_check.outputs.version_changed == 'true'
        id: release_check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.version_check.outputs.current_version }}
        run: |
          if gh release view "v$VERSION" >/dev/null 2>&1; then
            echo "release_exists=true" >> $GITHUB_OUTPUT
          else
            echo "release_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create release
        if: |
          steps.version_check.outputs.version_changed == 'true' &&
          steps.release_check.outputs.release_exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.version_check.outputs.current_version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v$VERSION" -m "Cursor v$VERSION"
          git push origin "v$VERSION"

          gh release create "v$VERSION" \
            --title "Cursor v$VERSION" \
            --notes "Auto-updated Cursor to version $VERSION.

          ## Installation

          \`\`\`nix
          inputs.code-cursor-nix.url = \"github:jacopone/code-cursor-nix/v$VERSION\";
          \`\`\`

          ## What's New

          See: https://www.cursor.com/changelog

          ## Features

          - üåê Browser Automation: Chrome bundled for Playwright/Puppeteer/Selenium
          - üöÄ Auto-updating: Updates 3x weekly
          - üì¶ Multi-platform: Linux & macOS (x86_64, aarch64)"

          echo "‚úì Created release v$VERSION"
